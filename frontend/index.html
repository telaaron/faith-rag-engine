<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Companion Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .iphone-frame {
            width: 390px; /* iPhone 13/14 Pro Width */
            height: 844px; /* iPhone 13/14 Pro Height */
            margin: 20px auto;
            border-radius: 55px;
            overflow: hidden;
            box-shadow: 
                0 0 0 12px #333, /* Bezel */
                0 0 0 13px #1a1a1a, /* Outer Frame */
                0 0 50px rgba(0,0,0,0.5); /* Shadow */
            background: #000; /* Deep Black Background */
            position: relative;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Glassmorphism for Modals */
        .glass {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* --- RICH AI CONTENT STYLING --- */
        
        /* General Text */
        .prose p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #e5e7eb; /* gray-200 */
        }

        /* Bold Text */
        .prose strong {
            color: #fff;
            font-weight: 700;
        }

        /* Blockquotes (Prayers) */
        .prose blockquote {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border-left: 4px solid #818cf8; /* indigo-400 */
            border-radius: 0 12px 12px 0;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-family: 'Georgia', serif;
            font-style: italic;
            color: #e0e7ff; /* indigo-100 */
            position: relative;
        }
        .prose blockquote::before {
            content: '"';
            font-size: 3rem;
            position: absolute;
            top: -10px;
            left: 10px;
            opacity: 0.2;
            color: #818cf8;
        }

        /* Lists (Action Steps) */
        .prose ul {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
        }
        .prose li {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem; /* Space for icon */
            margin-bottom: 0.75rem;
            position: relative;
            transition: all 0.2s ease;
        }
        .prose li:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px); /* Lift up instead of sliding right */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .prose li::before {
            content: '‚ú®'; /* Default icon */
            position: absolute;
            left: 1.25rem;
            top: 1.25rem;
            font-size: 1.2rem;
        }
        
        /* Make bold text act as a heading inside list items */
        .prose li strong {
            display: block;
            color: #fbbf24; /* amber-400 */
            margin-bottom: 0.25rem;
            font-size: 1.05em;
        }

        /* Headings */
        .prose h1, .prose h2, .prose h3 {
            color: white;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <div class="iphone-frame flex flex-col text-white relative">
        
        <!-- Dynamic Island (Notch) -->
        <div class="absolute top-3 left-1/2 transform -translate-x-1/2 w-[120px] h-[35px] bg-black rounded-full z-50 flex justify-end items-center pr-3">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse hidden" id="cameraIndicator"></div>
        </div>

        <!-- Status Bar -->
        <div class="h-14 w-full flex justify-between items-center px-8 pt-3 text-[15px] font-semibold select-none z-40 absolute top-0">
            <span id="clock">9:41</span>
            <div class="flex items-center space-x-1.5">
                <!-- Cellular Icon (iOS Style) -->
                <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 8.5C1 8.22386 1.22386 8 1.5 8H2.5C2.77614 8 3 8.22386 3 8.5V11.5C3 11.7761 2.77614 12 2.5 12H1.5C1.22386 12 1 11.7761 1 11.5V8.5Z" fill="white"/>
                    <path d="M5 6.5C5 6.22386 5.22386 6 5.5 6H6.5C6.77614 6 7 6.22386 7 6.5V11.5C7 11.7761 6.77614 12 6.5 12H5.5C5.22386 12 5 11.7761 5 11.5V6.5Z" fill="white"/>
                    <path d="M9 4.5C9 4.22386 9.22386 4 9.5 4H10.5C10.7761 4 11 4.22386 11 4.5V11.5C11 11.7761 10.7761 12 10.5 12H9.5C9.22386 12 9 11.7761 9 11.5V4.5Z" fill="white"/>
                    <path d="M13 2.5C13 2.22386 13.2239 2 13.5 2H14.5C14.7761 2 15 2.22386 15 2.5V11.5C15 11.7761 14.7761 12 14.5 12H13.5C13.2239 12 13 11.7761 13 11.5V2.5Z" fill="white" opacity="0.3"/>
                </svg>
                <!-- Wifi Icon (iOS Style) -->
                <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9 11.5C8.6875 11.5 8.3875 11.3875 8.1625 11.1625L1.6625 4.6625C1.4375 4.4375 1.4375 4.0625 1.6625 3.8375C3.6875 1.8125 6.3125 0.75 9 0.75C11.6875 0.75 14.3125 1.8125 16.3375 3.8375C16.5625 4.0625 16.5625 4.4375 16.3375 4.6625L9.8375 11.1625C9.6125 11.3875 9.3125 11.5 9 11.5Z" fill="white"/>
                </svg>
                <!-- Battery Icon (iOS Style) -->
                <svg width="26" height="12" viewBox="0 0 26 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="1" y="1" width="21" height="10" rx="2.5" stroke="white" stroke-opacity="0.3"/>
                    <rect x="3" y="3" width="17" height="6" rx="1.5" fill="white"/>
                    <path d="M24 4.5C24.8284 4.5 25.5 5.17157 25.5 6C25.5 6.82843 24.8284 7.5 24 7.5V4.5Z" fill="white" fill-opacity="0.3"/>
                </svg>
            </div>
        </div>

        <!-- Header Tabs -->
        <div class="mt-14 px-4 flex justify-between items-center z-10 pt-2">
            <div class="flex space-x-6 text-lg font-bold">
                <div class="relative pb-1">
                    <span class="text-white">Today</span>
                    <div class="absolute bottom-0 left-0 w-full h-0.5 bg-red-500 rounded-full"></div>
                </div>
                <span class="text-gray-500">Community</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center border border-gray-600">
                <span class="font-bold text-sm">A</span>
            </div>
        </div>

        <!-- Greeting & Stats -->
        <div class="px-4 mt-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Hello, Aaron!</h1>
            <div class="flex space-x-4 text-gray-400">
                <div class="flex items-center space-x-1">
                    <i data-lucide="zap" class="w-5 h-5 text-white fill-white"></i>
                    <span class="text-white font-bold">1</span>
                </div>
                <i data-lucide="bell" class="w-6 h-6"></i>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto hide-scrollbar pb-24 mt-4 space-y-6">

            <!-- FEATURE 1: Mindset Pulse (Subtle Integration) -->
            <div class="mx-4">
                <div onclick="openMindsetModal()" class="flex items-center justify-between bg-gray-800/50 border border-gray-700 p-3 rounded-xl cursor-pointer hover:bg-gray-800 transition group">
                    <div class="flex items-center space-x-3">
                        <div class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                        </div>
                        <span class="text-sm font-medium text-gray-300 group-hover:text-white transition">How is your soul?</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500"></i>
                </div>
            </div>

            <!-- Verse of the Day Card -->
            <div class="mx-4 relative aspect-[4/5] rounded-2xl overflow-hidden shadow-2xl group">
                <!-- Background Image -->
                <img src="https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="absolute inset-0 w-full h-full object-cover opacity-80" alt="Nature">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                
                <!-- Content -->
                <div class="absolute inset-0 p-6 flex flex-col justify-between">
                    <div class="mt-4">
                        <span class="text-xs font-semibold text-gray-300 uppercase tracking-wider">Verse of the Day</span>
                        <h2 class="text-lg font-bold mt-1">John 1:12</h2>
                    </div>

                    <div class="mb-12">
                        <p class="text-2xl font-serif leading-relaxed text-center drop-shadow-lg">
                            "But as many as received him, to them gave he power to become the sons of God, even to them that believe on his name."
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center px-2">
                        <div class="flex flex-col items-center space-y-1">
                            <i data-lucide="heart" class="w-6 h-6 text-red-500 fill-red-500"></i>
                            <span class="text-[10px] text-gray-300">691k</span>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
                            <span class="text-[10px] text-gray-300">10k</span>
                        </div>
                        
                        <!-- FEATURE 2: Deep Dive Button -->
                        <div onclick="openExplainModal()" class="flex flex-col items-center space-y-1 cursor-pointer transform hover:scale-110 transition">
                            <div class="bg-white/20 p-2 rounded-full backdrop-blur-md border border-white/30">
                                <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-300 fill-yellow-300/20"></i>
                            </div>
                            <span class="text-[10px] text-yellow-300 font-bold">Explain</span>
                        </div>

                        <div class="flex flex-col items-center space-y-1">
                            <i data-lucide="share-2" class="w-6 h-6 text-white"></i>
                            <span class="text-[10px] text-gray-300">250k</span>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <i data-lucide="more-horizontal" class="w-6 h-6 text-white"></i>
                            <span class="text-[10px] text-gray-300">More</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Word Card -->
            <div class="mx-4 bg-gray-900 p-4 rounded-2xl flex items-center space-x-4 border border-gray-800">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <i data-lucide="droplet" class="w-3 h-3 text-gray-500"></i>
                        <span class="text-xs text-gray-500">0</span>
                    </div>
                    <span class="text-xs text-gray-400 block mb-1">Daily in the Word</span>
                    <h3 class="font-bold text-sm leading-tight">Make it a habit to meditate on God's Word</h3>
                    <div class="flex items-center mt-2 text-xs text-gray-500">
                        <i data-lucide="play" class="w-3 h-3 mr-1 fill-gray-500"></i>
                        2-5 Minutes
                    </div>
                </div>
                <img src="https://images.unsplash.com/photo-1499209974431-9dddcece7f88?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="w-20 h-20 rounded-xl object-cover" alt="Daily">
            </div>

            <!-- FEATURE 3: Prayer Architect Teaser -->
            <div class="mx-4 bg-gradient-to-r from-indigo-900 to-purple-900 p-5 rounded-2xl border border-indigo-700/50 relative overflow-hidden" onclick="openPrayerModal()">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold text-indigo-300 uppercase tracking-wider">Prayer Architect</span>
                            <h3 class="font-bold text-lg mt-1">Speechless in prayer?</h3>
                            <p class="text-xs text-indigo-200 mt-1 max-w-[200px]">Let us help you put your thoughts into words.</p>
                        </div>
                        <div class="bg-indigo-500/30 p-2 rounded-lg">
                            <i data-lucide="pen-tool" class="w-6 h-6 text-indigo-300"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Bottom Navigation -->
        <div class="absolute bottom-0 w-full h-[85px] bg-gray-900/90 backdrop-blur-md border-t border-gray-800 flex justify-around items-start pt-3 text-[10px] text-gray-500 z-20 pb-8">
            <div class="flex flex-col items-center text-white">
                <i data-lucide="home" class="w-6 h-6 mb-1 fill-white"></i>
                <span>Home</span>
            </div>
            <div class="flex flex-col items-center hover:text-gray-300">
                <i data-lucide="book" class="w-6 h-6 mb-1"></i>
                <span>Bible</span>
            </div>
            <div class="flex flex-col items-center hover:text-gray-300">
                <i data-lucide="check-square" class="w-6 h-6 mb-1"></i>
                <span>Plans</span>
            </div>
            <div class="flex flex-col items-center hover:text-gray-300">
                <i data-lucide="search" class="w-6 h-6 mb-1"></i>
                <span>Discover</span>
            </div>
            <div class="flex flex-col items-center hover:text-gray-300">
                <i data-lucide="menu" class="w-6 h-6 mb-1"></i>
                <span>More</span>
            </div>
        </div>

        <!-- Home Indicator -->
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-[130px] h-[5px] bg-white rounded-full z-50"></div>

        <!-- ================= MODALS ================= -->

        <!-- 1. MINDSET MODAL -->
        <div id="mindsetModal" class="absolute inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeMindsetModal()"></div>
            <div class="absolute bottom-0 w-full h-[85%] glass rounded-t-3xl flex flex-col p-6 transition-transform duration-300 translate-y-full" id="mindsetContent">
                <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-6"></div>
                
                <!-- Input -->
                <div id="mindsetInput" class="flex-1 flex flex-col">
                    <h3 class="text-2xl font-bold mb-2">How are you?</h3>
                    <p class="text-gray-400 text-sm mb-6">Tell me briefly about your situation.</p>
                    
                    <!-- Mood Chips -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setMood('I feel stressed')" class="px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-xs font-bold text-gray-300 hover:bg-gray-700 hover:text-white transition">üò∞ Stressed</button>
                        <button onclick="setMood('I am grateful for...')" class="px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-xs font-bold text-gray-300 hover:bg-gray-700 hover:text-white transition">üôè Grateful</button>
                        <button onclick="setMood('I need wisdom for...')" class="px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-xs font-bold text-gray-300 hover:bg-gray-700 hover:text-white transition">üí° Clueless</button>
                        <button onclick="setMood('I feel lonely')" class="px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-xs font-bold text-gray-300 hover:bg-gray-700 hover:text-white transition">üòî Lonely</button>
                    </div>

                    <div class="relative flex-1 mb-4">
                        <textarea id="mindsetText" class="w-full h-full bg-gray-800/50 p-4 rounded-2xl border border-gray-700 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white resize-none text-lg leading-relaxed placeholder-gray-600 transition" placeholder="Write here..."></textarea>
                        <div class="absolute bottom-4 right-4 text-gray-600 text-xs">
                            <i data-lucide="mic" class="w-5 h-5 hover:text-blue-500 cursor-pointer transition"></i>
                        </div>
                    </div>

                    <button onclick="submitMindset()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-900/20 transition transform active:scale-[0.98]">
                        Submit
                    </button>
                </div>

                <!-- Loading -->
                <div id="mindsetLoading" class="hidden flex-1 flex flex-col justify-center items-center">
                    <div class="relative">
                        <div class="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full"></div>
                        <i data-lucide="loader-2" class="relative w-12 h-12 text-blue-500 animate-spin mb-4"></i>
                    </div>
                    <p class="text-gray-300 font-medium">Searching for spiritual impulses...</p>
                    <p class="text-gray-500 text-xs mt-2">Analyzing your situation</p>
                </div>

                <!-- Result (Chat Interface) -->
                <div id="mindsetResult" class="hidden flex-1 flex flex-col h-full">
                    <!-- Chat History Area -->
                    <div id="mindsetChatContainer" class="flex-1 overflow-y-auto hide-scrollbar space-y-6 pb-4">
                        <!-- Messages will be appended here -->
                    </div>
                    
                    <!-- Input Area -->
                    <div class="mt-2 pt-2 border-t border-gray-700">
                        <div class="relative flex items-center">
                            <input type="text" id="mindsetChatInput" class="w-full bg-gray-800 text-white rounded-full py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Reply or ask more..." onkeypress="handleChatKey(event)">
                            <button onclick="submitFollowUp()" class="absolute right-2 p-2 bg-blue-600 rounded-full hover:bg-blue-500 transition">
                                <i data-lucide="send" class="w-4 h-4 text-white"></i>
                            </button>
                        </div>
                        <button onclick="closeMindsetModal()" class="mt-3 w-full text-xs text-gray-500 hover:text-gray-300">Close Conversation</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. EXPLAIN MODAL (Deep Dive) -->
        <div id="explainModal" class="absolute inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeExplainModal()"></div>
            <div class="absolute bottom-0 w-full h-[70%] glass rounded-t-3xl flex flex-col p-6 transition-transform duration-300 translate-y-full" id="explainContent">
                <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-4"></div>
                
                <div class="flex items-center space-x-2 mb-4 text-yellow-400">
                    <i data-lucide="lightbulb" class="w-5 h-5"></i>
                    <span class="font-bold uppercase text-xs tracking-wider">Deep Dive</span>
                </div>

                <h3 class="text-xl font-serif italic text-gray-300 mb-6">"But as many as received him..."</h3>

                <div class="grid grid-cols-3 gap-2 mb-6">
                    <button onclick="explainVerse('explain_like_5', this)" class="explain-btn bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center text-center space-y-2 border border-gray-700 transition">
                        <span class="text-2xl">üë∂</span>
                        <span class="text-[10px] font-bold text-gray-300">Simple</span>
                    </button>
                    <button onclick="explainVerse('historical', this)" class="explain-btn bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center text-center space-y-2 border border-gray-700 transition">
                        <span class="text-2xl">üìú</span>
                        <span class="text-[10px] font-bold text-gray-300">Historical</span>
                    </button>
                    <button onclick="explainVerse('application', this)" class="explain-btn bg-gray-800 hover:bg-gray-700 p-3 rounded-xl flex flex-col items-center text-center space-y-2 border border-gray-700 transition">
                        <span class="text-2xl">üöÄ</span>
                        <span class="text-[10px] font-bold text-gray-300">Application</span>
                    </button>
                </div>

                <div id="explainLoading" class="hidden py-10 text-center">
                    <i data-lucide="loader-2" class="w-8 h-8 text-yellow-400 animate-spin mx-auto mb-2"></i>
                    <p class="text-xs text-gray-500">Analyzing theology...</p>
                </div>

                <div id="explainResult" class="flex-1 overflow-y-auto hide-scrollbar prose prose-invert prose-sm">
                    <p class="text-gray-400 italic text-center mt-10">Select a mode above to understand the verse deeper.</p>
                </div>
            </div>
        </div>

        <!-- 3. PRAYER MODAL -->
        <div id="prayerModal" class="absolute inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePrayerModal()"></div>
            <div class="absolute bottom-0 w-full h-[85%] glass rounded-t-3xl flex flex-col p-6 transition-transform duration-300 translate-y-full" id="prayerContent">
                <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-6"></div>
                
                <!-- Input -->
                <div id="prayerInput" class="flex-1 flex flex-col">
                    <div class="flex items-center space-x-2 mb-2 text-indigo-400">
                        <i data-lucide="pen-tool" class="w-5 h-5"></i>
                        <span class="font-bold uppercase text-xs tracking-wider">Prayer Architect</span>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">What do you want to pray for?</h3>
                    <p class="text-gray-400 text-sm mb-6">Give me a few keywords or feelings.</p>
                    
                    <div class="relative flex-1 mb-4">
                        <textarea id="prayerText" class="w-full h-full bg-gray-800/50 p-4 rounded-2xl border border-gray-700 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-white resize-none text-lg leading-relaxed placeholder-gray-600 transition" placeholder="e.g. Exam anxiety, Math, need rest..."></textarea>
                    </div>

                    <button onclick="submitPrayer()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-900/20 transition transform active:scale-[0.98]">
                        Formulate Prayer
                    </button>
                </div>

                <!-- Loading -->
                <div id="prayerLoading" class="hidden flex-1 flex flex-col justify-center items-center">
                    <div class="relative">
                        <div class="absolute inset-0 bg-indigo-500 blur-xl opacity-20 rounded-full"></div>
                        <i data-lucide="loader-2" class="relative w-12 h-12 text-indigo-500 animate-spin mb-4"></i>
                    </div>
                    <p class="text-gray-300 font-medium">Formulating prayer...</p>
                </div>

                <!-- Result -->
                <div id="prayerResult" class="hidden flex-1 flex flex-col overflow-y-auto hide-scrollbar">
                    <div class="prose prose-invert prose-sm mb-6 leading-relaxed text-gray-200 font-serif italic text-lg" id="prayerResponseText"></div>
                    <button onclick="closePrayerModal()" class="mt-6 w-full bg-gray-800 hover:bg-gray-700 py-4 rounded-xl font-bold text-gray-300 transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- MINDSET LOGIC ---
        let chatHistory = ""; // Stores the conversation history

        function openMindsetModal() {
            document.getElementById('mindsetModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('mindsetContent').classList.remove('translate-y-full'), 10);
        }
        function closeMindsetModal() {
            document.getElementById('mindsetContent').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('mindsetModal').classList.add('hidden');
                // Reset UI for next time (optional, but good for MVP)
                // For now we keep the chat history in memory but maybe clear UI if desired?
                // Let's keep it simple: reload page clears history.
            }, 300);
        }
        function setMood(text) {
            document.getElementById('mindsetText').value = text;
            document.getElementById('mindsetText').focus();
        }

        function appendUserMessage(text) {
            const container = document.getElementById('mindsetChatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = "flex justify-end";
            msgDiv.innerHTML = `
                <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[80%] text-sm">
                    ${text}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            // Update history string
            chatHistory += `User: ${text}\n`;
        }

        function appendAIMessage(markdownText, sources = []) {
            const container = document.getElementById('mindsetChatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = "flex flex-col items-start max-w-[90%]";
            
            let sourcesHtml = "";
            if (sources && sources.length > 0) {
                sourcesHtml = `<div class="mt-3 space-y-2 w-full">`;
                sources.forEach(s => {
                    sourcesHtml += `
                        <div class="bg-gray-800/50 p-2 rounded border border-gray-700/50 text-[10px]">
                            <p class="italic text-gray-400">"${s.text}"</p>
                            <p class="text-blue-400 font-bold mt-1 text-right">${s.ref}</p>
                        </div>`;
                });
                sourcesHtml += `</div>`;
            }

            msgDiv.innerHTML = `
                <div class="bg-gray-800 text-gray-200 px-4 py-3 rounded-2xl rounded-tl-none text-sm prose prose-invert prose-sm max-w-none">
                    ${marked.parse(markdownText)}
                </div>
                ${sourcesHtml}
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;

            // Update history string
            chatHistory += `AI: ${markdownText}\n`;
        }

        async function submitMindset() {
            const text = document.getElementById('mindsetText').value;
            if(!text) return;
            
            // 1. Switch UI to Chat Mode
            document.getElementById('mindsetInput').classList.add('hidden');
            document.getElementById('mindsetLoading').classList.remove('hidden');
            
            // 2. Add User Message to Chat
            appendUserMessage(text);

            try {
                const res = await fetch('http://127.0.0.1:8000/api/mindset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text, history: chatHistory})
                });
                const data = await res.json();
                
                document.getElementById('mindsetLoading').classList.add('hidden');
                document.getElementById('mindsetResult').classList.remove('hidden');
                
                appendAIMessage(data.response, data.sources);
                
            } catch(e) {
                alert('Error: ' + e);
                closeMindsetModal();
            }
        }

        async function submitFollowUp() {
            const input = document.getElementById('mindsetChatInput');
            const text = input.value;
            if(!text) return;

            input.value = ""; // Clear input
            appendUserMessage(text);
            
            // Show a small loading indicator in chat? 
            // For MVP, we just wait. Or we could append a temporary "Typing..." bubble.
            const container = document.getElementById('mindsetChatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = "tempLoading";
            loadingDiv.className = "flex items-center space-x-2 text-gray-500 text-xs ml-2 mt-2";
            loadingDiv.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> <span>Thinking...</span>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons(); // Refresh icons for the new loader

            try {
                const res = await fetch('http://127.0.0.1:8000/api/mindset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text, history: chatHistory})
                });
                const data = await res.json();
                
                document.getElementById('tempLoading').remove();
                appendAIMessage(data.response, data.sources);
                
            } catch(e) {
                document.getElementById('tempLoading').remove();
                alert('Error: ' + e);
            }
        }

        function handleChatKey(e) {
            if(e.key === 'Enter') submitFollowUp();
        }

        // --- EXPLAIN LOGIC ---
        function openExplainModal() {
            document.getElementById('explainModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('explainContent').classList.remove('translate-y-full'), 10);
        }
        function closeExplainModal() {
            document.getElementById('explainContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('explainModal').classList.add('hidden'), 300);
        }
        async function explainVerse(mode, btnElement) {
            // UI Selection Logic
            document.querySelectorAll('.explain-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-yellow-500', 'bg-gray-700');
                btn.classList.add('bg-gray-800');
            });
            if(btnElement) {
                btnElement.classList.remove('bg-gray-800');
                btnElement.classList.add('bg-gray-700', 'ring-2', 'ring-yellow-500');
            }

            document.getElementById('explainResult').innerHTML = '';
            document.getElementById('explainLoading').classList.remove('hidden');
            
            // Verse is hardcoded for demo
            const verse = "John 1:12 - But as many as received him, to them gave he power to become the sons of God, even to them that believe on his name.";

            try {
                const res = await fetch('http://127.0.0.1:8000/api/explain', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: verse, mode: mode})
                });
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.detail || 'Unknown error occurred');
                }
                
                document.getElementById('explainLoading').classList.add('hidden');
                if (data.response) {
                    document.getElementById('explainResult').innerHTML = marked.parse(data.response);
                } else {
                    document.getElementById('explainResult').innerHTML = '<p class="text-red-500">No response received.</p>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('explainLoading').classList.add('hidden');
                document.getElementById('explainResult').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
            }
        }

        // --- PRAYER LOGIC ---
        function openPrayerModal() {
            document.getElementById('prayerModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('prayerContent').classList.remove('translate-y-full'), 10);
        }
        function closePrayerModal() {
            document.getElementById('prayerContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('prayerModal').classList.add('hidden'), 300);
        }
        async function submitPrayer() {
            const text = document.getElementById('prayerText').value;
            if(!text) return;

            document.getElementById('prayerInput').classList.add('hidden');
            document.getElementById('prayerLoading').classList.remove('hidden');

            try {
                const res = await fetch('http://127.0.0.1:8000/api/prayer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text: text})
                });
                const data = await res.json();
                
                document.getElementById('prayerResponseText').innerHTML = marked.parse(data.prayer);
                
                document.getElementById('prayerLoading').classList.add('hidden');
                document.getElementById('prayerResult').classList.remove('hidden');
            } catch(e) {
                alert('Error: ' + e);
                closePrayerModal();
            }
        }

    </script>
</body>
</html>
